<%- include('../layouts/admin/header.ejs') %>

<style>
    .truncate {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 150px; /* Adjust the width as per your requirement */
        display: block;
    }

    .table thead th {
        border-bottom: 2px solid #dee2e6;
    }

    .table tbody tr td {
        border-top: 1px solid #dee2e6;
    }

    .card {
        margin: 15px;
    }

    .card-header {
        background: linear-gradient(87deg, #11cdef 0, #117a8b 100%) !important;
        color: #fff;
    }

    .btn {
        margin: 5px;
    }

    .modal-header {
        background-color: #5e72e4;
        color: #fff;
    }

    .modal-content {
        border-radius: 0.5rem;
    }
</style>

<body class="g-sidenav-show bg-gray-200">

    <aside
    class="sidenav navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-3   bg-gradient-dark"
    id="sidenav-main">
    <div class="sidenav-header" style="margin: 15px;">
        <i class="fas fa-times p-3 cursor-pointer text-white opacity-5 position-absolute end-0 top-0 d-none d-xl-none"
            aria-hidden="true" id="iconSidenav"></i>
        <a class="navbar-brand m-0" href=" https://demos.creative-tim.com/material-dashboard/pages/dashboard "
            target="_blank"></a>
        <img src="/public/assets/images/icons/sacecart-01 1.png" class="navbar-brand-img h-100" alt="main_logo">
        <span class="ms-1 font-weight-bold text-white">Material Dashboard</span>
        </a>
    </div>
    <hr class="horizontal light mt-0 mb-2">
    <!-- <div class="collapse navbar-collapse  w-auto  max-height-vh-100" id="sidenav-collapse-main"> -->
    <ul class="navbar-nav">
        <li class="nav-item">
            <a class="nav-link" href="/admin/home">
                <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                    <i class="material-icons opacity-10">dashboard</i>
                </div>
                <span class="nav-link-text ms-1">Dashboard</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link text-white " href="/admin/view-users">
                <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                    <i class="material-icons opacity-10">group</i>
                </div>
                <span class="nav-link-text ms-1">Users</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link text-white active bg-gradient-primary" href="/admin/view-category">
                <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                    <i class="material-icons opacity-10">inventory_2</i>
                </div>
                <span class="nav-link-text ms-1">Category</span>
            </a>
        </li>

        <li class="nav-item">
            <a class="nav-link text-white " href="/admin/view-product">
                <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                    <i class="material-icons opacity-10">branding_watermark</i>
                </div>
                <span class="nav-link-text ms-1">Porducts</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link text-white" href="/admin/view-brand">
                <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                    <i class="material-icons opacity-10">category</i>
                </div>
                <span class="nav-link-text ms-1">Brand</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link text-white " href="/admin/view-orders">
                <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                    <i class="material-icons opacity-10">wysiwyg</i>
                </div>
                <span class="nav-link-text ms-1">Orders</span>
            </a>
        </li>
            <li class="nav-item">
                <a class="nav-link text-white " href="/admin/view-coupon">
                <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                    <i class="material-icons opacity-10">redeem</i>
                </div>
                <span class="nav-link-text ms-1">Coupon</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link text-white" href="/admin/view-offers">
                  <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                    <i class="material-icons opacity-10">local_offer</i>
                  </div>
                  <span class="nav-link-text ms-1">Offers</span>
                </a>
              </li>
        <li class="nav-item mt-3">
            <h6 class="ps-4 ms-2 text-uppercase text-xs text-white font-weight-bolder opacity-8">Account pages
            </h6>
        </li>
        <li class="nav-item">
            <a class="nav-link text-white " href="./pages/profile.html">
                <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                    <i class="material-icons opacity-10">person</i>
                </div>
                <span class="nav-link-text ms-1">Profile</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link text-white " href="/admin/logout">
                <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                    <i class="material-icons opacity-10">logout</i>
                </div>
                <span class="nav-link-text ms-1">Log out</span>
            </a>
        </li>
        <!-- <li class="nav-item">
  <a class="nav-link text-white " href="./pages/sign-up.html">
    <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
      <i class="material-icons opacity-10">assignment</i>
    </div>
    <span class="nav-link-text ms-1">Sign Up</span>
  </a>
</li> -->
    </ul>
    <!-- </div> -->
    <!-- <div class="sidenav-footer position-absolute w-100 bottom-0 ">
<div class="mx-3">
<a class="btn bg-gradient-primary mt-4 w-100" href="https://www.creative-tim.com/product/material-dashboard-pro?ref=sidebarfree" type="button">Upgrade to pro</a>
</div>
</div> -->
</aside>


    <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg">
        <%- include('../layouts/admin/navbar.ejs') %>

        <div class="container-fluid py-4">
            <div class="row">
                <div class="col-12">
                    <div class="card my-4">
                        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
                            <div class="bg-gradient-primary shadow-primary border-radius-lg">
                                <div class="row justify-content-lg-between align-items-center margin-0 py-0">
                                    <div class="col-md-12 col-lg-6 mb-2 mb-lg-0">
                                        <h6 class="text-white text-capitalize ps-3"><%= title %></h6>
                                    </div>
                                    <div class="col-md-12 col-lg-6">
                                        <div class="d-flex justify-content-end">
                                            <a class="btn bg-gradient-dark mb-0" href="/admin/add-category">
                                                <i class="material-icons text-sm">add</i>&nbsp;&nbsp;Add Category
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body px-0 pb-2">
                            <div class="table-responsive p-0">
                                <table class="table align-items-center mb-0">
                                    <thead>
                                        <tr>
                                            <th class="text-uppercase text-secondary text-xxs font-weight-bolder ps-2">No</th>
                                            <th class="text-uppercase text-secondary text-xxs font-weight-bolder ps-2">Category Name</th>
                                            <th class="text-uppercase text-secondary text-xxs font-weight-bolder ps-2">Description</th>
                                            <th class="text-uppercase text-secondary text-xxs font-weight-bolder ps-2">Image</th>
                                            <th class="text-uppercase text-secondary text-xxs font-weight-bolder ps-2">Update</th>
                                            <th class="text-uppercase text-secondary text-xxs font-weight-bolder  ps-2">Action</th>

                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% categoryData.forEach((cat, index) => { %>
                                        <tr>
                                            <td><%= index + 1 %></td>
                                            <td><%= cat.categoryName %></td>
                                            <td><p class="text-sm font-weight-bold mb-0 truncate"><%= cat.description %></p></td>
                                            <td><img src="/public/userImages/<%= cat.image %>" class="avatar avatar-sm me-3" alt="category image"></td>
                                            <td><a href="/admin/edit-category?id=<%= cat._id %>" class="btn btn-warning btn-sm">Edit</a></td>
                                           
                                          
                                            
                                            <td class="align-middle text-center text-sm">
                                                <% if (!cat.is_block) { %>
                                                <span class="badge badge-sm bg-gradient-success">Listed</span>
                                                <% } else { %>
                                                <span class="badge badge-sm bg-gradient-danger">Unlisted</span>
                                                <% } %>
                                                <% if (!cat.is_block) { %>
                                                <a href="/admin/is_blockCategory?id=<%= cat._id %>" class="btn btn-danger btn-sm mt-1">Unlist</a>
                                                <% } else { %>
                                                <a href="/admin/is_blockCategory?id=<%= cat._id %>" class="btn btn-success btn-sm mt-1">List</a>
                                                <% } %>
                                            </td>
                                        </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Offer Modal -->
        <div class="modal fade" id="offerModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Offer List</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="background-color: black;"></button>
                    </div>
                    <div class="modal-body" id="offer-modal_1">
                        <% if (availableOffers && availableOffers.length > 0) { %>
                            <% availableOffers.forEach((offer) => { %>
                            <div class="card" style="width: 25rem; background-color: cadetblue;">
                                <div class="card-body custom-card-background" style="height: .25rem;">
                                    <h5 class="card-title" style="color: white;"><%= offer.offerName %></h5>
                                </div>
                                <ul class="list-group list-group-flush" style="background-color: rgb(238, 10, 97);">
                                    <li class="list-group-item" style="color: black;">Starting Date:<%= new Date(offer.startingDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: '2-digit' }).replace(/\//g, '-') %></li>
                                    <li class="list-group-item" style="color: black;">Expiry Date:<%= new Date(offer.expiryDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: '2-digit' }).replace(/\//g, '-') %></li>
                                    <li class="list-group-item" style="color: black;">Discount:<%= offer.percentage %>%</li>
                                </ul>
                            </div>
                            <div class="d-flex mt-2">
                                <button type="button" onclick="applyOffer('<%= offer._id %>')" class="btn btn-primary">Apply</button>
                            </div>
                            <% }); %>
                        <% } else { %>
                            <h1 class="text-info text">Offer not found</h1>
                        <% } %>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <%- include('../layouts/admin/footer.ejs') %>

    <!-- Bootstrap 5 JS bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Include jQuery from a CDN -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Include SweetAlert2 from a CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Modal Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var openOfferModalButtons = document.querySelectorAll('.open-offer-modal');

            openOfferModalButtons.forEach(function (button) {
                button.addEventListener('click', function (e) {
                    var catId = button.getAttribute('data-cat-id');
                    updateModalContent(catId);
                });
            });

            function updateModalContent(catId) {
                var modal_1 = document.getElementById('offer-modal_1');
                modal_1.setAttribute('cid', catId);
                var modalTitle = document.querySelector('#exampleModalLabel');
                modalTitle.innerText = 'Offer List for Category ID: ' + catId;
            }
        });
    </script>

<script>
    function applyOffer(offerId) {
        const cid = document.getElementById('offer-modal_1').getAttribute('cid');
        $.ajax({
            url: '/admin/applyOffer',
            method: 'PATCH',
            data: { offerId: offerId, categoryId: cid },
            success: function (response) {
                if (response.status) {
                    Swal.fire({
                        icon: "success",
                        title: 'Offer Applied successfully.',
                        showConfirmButton: false,
                        timer: 1500
                    }).then(() => {
                        location.reload();
                    })
                }
            },
            error: function () {
                // Handle the case when the AJAX request encounters an error
                Swal.fire({
                    title: "Error!",
                    text: "Unable to communicate with the server.",
                    icon: "error"
                });
            }
        });
    }

    function removeOffer(categoryId) {
        Swal.fire({
            title: "Are you sure?",
            text: "You won't be able to revert this!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Yes, remove it!"
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '/admin/removeOffer',
                    method: 'PATCH',
                    data: { categoryId: categoryId },
                    success: function (response) {
                        if (response.status) {
                            Swal.fire({
                                title: "Removed!",
                                text: "Your file has been removed.",
                                icon: "success"
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            // Handle the case when deletion is not successful
                            Swal.fire({
                                title: "Error!",
                                text: "Unable to delete the file.",
                                icon: "error"
                            });
                        }
                    },
                    error: function () {
                        // Handle the case when the AJAX request encounters an error
                        Swal.fire({
                            title: "Error!",
                            text: "Unable to communicate with the server.",
                            icon: "error"
                        });
                    }
                });
            }
        });

    }
</script>
