<%- include('../layouts/admin/header.ejs') %>

<body class="g-sidenav-show bg-gray-200">

<main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg">
    <aside class="sidenav navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-3 bg-gradient-dark" id="sidenav-main">
        <div class="sidenav-header" style="margin: 15px;">
            <i class="fas fa-times p-3 cursor-pointer text-white opacity-5 position-absolute end-0 top-0 d-none d-xl-none" aria-hidden="true" id="iconSidenav"></i>
            <a class="navbar-brand m-0" href="https://demos.creative-tim.com/material-dashboard/pages/dashboard" target="_blank">
                <img src="/public/assets/images/icons/sacecart-01 1.png" class="navbar-brand-img h-100" alt="main_logo">
                <span class="ms-1 font-weight-bold text-white"></span>
            </a>
        </div>
        <hr class="horizontal light mt-0 mb-2">
        <ul class="navbar-nav">
            <!-- Sidebar Navigation Items -->
            <li class="nav-item">
                <a class="nav-link text-white" href="/admin/home">
                    <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="material-icons opacity-10">dashboard</i>
                    </div>
                    <span class="nav-link-text ms-1">Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link text-white active bg-gradient-primary" href="/admin/sales-report">
                    <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="material-icons opacity-10">bar_chart</i>
                    </div>
                    <span class="nav-link-text ms-1">Sales Report</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link text-white " href="/admin/view-users">
                    <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="material-icons opacity-10">group</i>
                    </div>
                    <span class="nav-link-text ms-1">Users</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link text-white " href="/admin/view-category">
                    <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="material-icons opacity-10">inventory_2</i>
                    </div>
                    <span class="nav-link-text ms-1">Category</span>
                </a>
            </li>
    
            <li class="nav-item">
                <a class="nav-link text-white " href="/admin/view-product">
                    <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="material-icons opacity-10">branding_watermark</i>
                    </div>
                    <span class="nav-link-text ms-1">Porducts</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link text-white " href="/admin/view-brand">
                    <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="material-icons opacity-10">category</i>
                    </div>
                    <span class="nav-link-text ms-1">Brand</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link text-white " href="/admin/view-orders">
                    <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="material-icons opacity-10">wysiwyg</i>
                    </div>
                    <span class="nav-link-text ms-1">Orders</span>
                </a>
            </li>
                <li class="nav-item">
                    <a class="nav-link text-white " href="/admin/view-coupon">
                    <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="material-icons opacity-10">redeem</i>
                    </div>
                    <span class="nav-link-text ms-1">Coupon</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white" href="/admin/view-offers">
                      <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="material-icons opacity-10">local_offer</i>
                      </div>
                      <span class="nav-link-text ms-1">Offers</span>
                    </a>
                  </li>
            <li class="nav-item mt-3">
                <h6 class="ps-4 ms-2 text-uppercase text-xs text-white font-weight-bolder opacity-8">Account pages
                </h6>
            </li>
            <li class="nav-item">
                <a class="nav-link text-white " href="./pages/profile.html">
                    <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="material-icons opacity-10">person</i>
                    </div>
                    <span class="nav-link-text ms-1">Profile</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link text-white " href="/admin/logout">
                    <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                        <i class="material-icons opacity-10">logout</i>
                    </div>
                    <span class="nav-link-text ms-1">Log out</span>
                </a>
            </li>
            <!-- Other sidebar links go here -->
        </ul>
    </aside>
    <!-- End of Sidebar -->


   
    <!-- Main Content Area -->
    <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg">
        <div class="container-fluid py-4">
            <div class="row">
                <div class="col-12">
                    <div class="card my-4">
                        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
                            <div class="bg-gradient-primary shadow-primary border-radius-lg pt-4 pb-3">
                                <h6 class="text-white text-capitalize ps-3">Sales Report</h6>
                            </div>
                        </div>
                        <div class="card-body px-0 pb-2">
                            <div class="table-responsive p-0">
                                <form action="" method="get" class="p-4">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="fromDate" class="form-label">From:</label>
                                            <input type="date" name="fromDate" id="fromDate" class="form-control" required>
                                            <small id="fromDateErr" class="error"></small>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="toDate" class="form-label">To:</label>
                                            <input type="date" name="toDate" id="toDate" class="form-control" required>
                                            <small id="toDateErr" class="error"></small>
                                        </div>
                                    </div>
                                    <div class="text-center mt-4">
                                        <button class="btn btn-success" type="submit" onclick="return validateSalesDate()">Get Sales Report</button>
                                        <a href="/admin/sales-report" class="btn btn-secondary ms-2">Reset</a>
                                    </div>
                                </form>

                                <% if (orderDataToDownload && orderDataToDownload.length > 0) { %>
                                    <div class="d-flex justify-content-between mb-2 px-4">
                                        <button class="btn btn-primary" onclick="printTable()">Export Pdf <i class="bi bi-filetype-pdf"></i></button>
                                        <button onclick="exportReportToExcel()" class="btn btn-success">Export Excel <i class="bi bi-file-earmark-spreadsheet"></i></button>
                                    </div>
                                    <div class="table-responsive p-0">
                                        <table class="table align-items-center mb-4">
                                            <thead>
                                                <tr style="background-color: rgb(227, 225, 225);">
                                                    <th class="text-uppercase text-xxs font-weight-bolder ps-2" style="color: black;">No</th>
                                                    <th class="text-uppercase text-xxs font-weight-bolder ps-2" style="color: black;">Date</th>
                                                    <th class="text-uppercase text-xxs font-weight-bolder ps-2" style="color: black;">User</th>
                                                    <th class="text-uppercase text-xxs font-weight-bolder ps-2" style="color: black;">OrderId</th>
                                                    <th class="text-uppercase text-xxs font-weight-bolder ps-2" style="color: black;">Total Price</th>
                                                    <th class="text-uppercase text-xxs font-weight-bolder ps-2" style="color: black;">Payment</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% orderDataToDownload.forEach((order, index) => { %>
                                                    <tr>
                                                        <td><p class="text-xs font-weight-bold mb-0"><%= index + 1 %></p></td>
                                                        <% const dd = order.createdAt.getDate(); const mm = order.createdAt.getMonth() + 1; const yyyy = order.createdAt.getFullYear(); const formattedDate = `${dd}-${mm}-${yyyy}`; %>
                                                        <td><p class="text-xs font-weight-bold mb-0"><%= formattedDate %></p></td>
                                                        <td><p class="text-xs font-weight-bold mb-0"><%= order.userName %></p></td>
                                                        <td><p class="text-xs font-weight-bold mb-0"><%= order._id %></p></td>
                                                        <td><p class="text-xs font-weight-bold mb-0">&#8377;<%= order.totalAmount %></p></td>
                                                        <td><p class="text-xs font-weight-bold mb-0"><%= order.paymentMethod %></p></td>
                                                    </tr>
                                                <% }) %>
                                            </tbody>
                                        </table>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript for Export and Print Functions -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.8/xlsx.full.min.js"></script>
    <script>
        function exportReportToExcel() {
            const table = document.getElementById("sortTable");
            const workbook = XLSX.utils.table_to_book(table);
            const excelBinary = XLSX.write(workbook, { bookType: "xlsx", type: "binary" });
            const blob = new Blob([s2ab(excelBinary)], { type: "application/octet-stream" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "salesReport.xlsx";
            link.click();
        }

        function s2ab(s) {
            const buf = new ArrayBuffer(s.length);
            const view = new Uint8Array(buf);
            for (let i = 0; i < s.length; i++) {
                view[i] = s.charCodeAt(i) & 0xff;
            }
            return buf;
        }

        function printTable() {
            var table = document.getElementById("sortTable");
            var newWin = window.open('', 'Print-Window');
            newWin.document.open();
            newWin.document.write('<html><head><style>');
            newWin.document.write('table { border-collapse: collapse; width: 100%; }');
            newWin.document.write('table, th, td { border: 1px solid black; }');
            newWin.document.write('</style></head><body onload="window.print()">');
            newWin.document.write(table.outerHTML);
            newWin.document.write('</body></html>');
            newWin.document.close();
            setTimeout(function () { newWin.close(); }, 10);
        }
    </script>

<%- include('../layouts/admin/footer.ejs') %>