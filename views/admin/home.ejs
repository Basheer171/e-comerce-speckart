<%- include('../layouts/admin/header.ejs') %>






  <body class="g-sidenav-show  bg-gray-200">
    <aside
      class="sidenav navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-3   bg-gradient-dark"
      id="sidenav-main">
      <div class="sidenav-header" style="margin: 15px;">
        <i class="fas fa-times p-3 cursor-pointer text-white opacity-5 position-absolute end-0 top-0 d-none d-xl-none"
          aria-hidden="true" id="iconSidenav"></i>
        <a class="navbar-brand m-0" href=" https://demos.creative-tim.com/material-dashboard/pages/dashboard "
          target="_blank"></a>
        <img src="/public/assets/images/icons/sacecart-01 1.png" class="navbar-brand-img h-100" alt="main_logo">
        <span class="ms-1 font-weight-bold text-white">Material Dashboard</span>
        </a>
      </div>
      <hr class="horizontal light mt-0 mb-2">
      <!-- <div class="collapse navbar-collapse  w-auto  max-height-vh-100" id="sidenav-collapse-main"> -->
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link text-white active bg-gradient-primary" href="/admin/home">
            <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="material-icons opacity-10">dashboard</i>
            </div>
            <span class="nav-link-text ms-1">Dashboard</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-white " href="/admin/view-users">
            <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="material-icons opacity-10">group</i>
            </div>
            <span class="nav-link-text ms-1">Users</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-white " href="/admin/view-category">
            <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="material-icons opacity-10">inventory_2</i>
            </div>
            <span class="nav-link-text ms-1">Category</span>
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link text-white " href="/admin/view-product">
            <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="material-icons opacity-10">branding_watermark</i>
            </div>
            <span class="nav-link-text ms-1">Porducts</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-white" href="/admin/view-brand">
            <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="material-icons opacity-10">category</i>
            </div>
            <span class="nav-link-text ms-1">Brand</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-white " href="/admin/view-orders">
            <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="material-icons opacity-10">wysiwyg</i>
            </div>
            <span class="nav-link-text ms-1">Orders</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-white " href="/admin/view-coupon">
            <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="material-icons opacity-10">redeem</i>
            </div>
            <span class="nav-link-text ms-1">Coupon</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-white" href="/admin/view-offers">
            <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="material-icons opacity-10">local_offer</i>
            </div>
            <span class="nav-link-text ms-1">Offers</span>
          </a>
        </li>
        <li class="nav-item mt-3">
          <h6 class="ps-4 ms-2 text-uppercase text-xs text-white font-weight-bolder opacity-8">Account pages
          </h6>
        </li>
        <li class="nav-item">
          <a class="nav-link text-white " href="./pages/profile.html">
            <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="material-icons opacity-10">person</i>
            </div>
            <span class="nav-link-text ms-1">Profile</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-white " href="/admin/logout">
            <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="material-icons opacity-10">logout</i>
            </div>
            <span class="nav-link-text ms-1">Log out</span>
          </a>
        </li>
        <!-- <li class="nav-item">
<a class="nav-link text-white " href="./pages/sign-up.html">
  <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
    <i class="material-icons opacity-10">assignment</i>
  </div>
  <span class="nav-link-text ms-1">Sign Up</span>
</a>
</li> -->
      </ul>
      <!-- </div> -->
      <!-- <div class="sidenav-footer position-absolute w-100 bottom-0 ">
<div class="mx-3">
<a class="btn bg-gradient-primary mt-4 w-100" href="https://www.creative-tim.com/product/material-dashboard-pro?ref=sidebarfree" type="button">Upgrade to pro</a>
</div>
</div> -->
    </aside>
    <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg ">
      <!-- Navbar -->

      <!-- End Navbar -->
      <div class="container-fluid py-4">

        <div class="row">

          <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
            <div class="card">
              <div class="card-header p-3 pt-2">
                <div
                  class="icon icon-lg icon-shape bg-gradient-dark shadow-dark text-center border-radius-xl mt-n4 position-absolute">
                  <i class="material-icons opacity-10">weekend</i>
                </div>
                <div class="text-end pt-1">
                  <p class="text-sm mb-0 text-capitalize">Total Revenue</p>
                  <h4 class="mb-0">&#8377; <%= totalIncome %>
                  </h4>
                </div>
              </div>
              <hr class="dark horizontal my-0">
              <div class="card-footer p-3">
                <p class="mb-0"><span class="text-success text-sm font-weight-bolder">+ &#8377;<%= thisMonthIncome %>
                      </span> on this month</p>
              </div>
            </div>
          </div>



          <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
            <div class="card">
              <div class="card-header p-3 pt-2">
                <div
                  class="icon icon-lg icon-shape bg-gradient-primary shadow-primary text-center border-radius-xl mt-n4 position-absolute">
                  <i class="material-icons opacity-10">person</i>
                </div>
                <div class="text-end pt-1">
                  <p class="text-sm mb-0 text-capitalize">Total Users</p>
                  <h4 class="mb-0">
                    <%= totalUsersCount? totalUsersCount: 0 %>
                  </h4>
                </div>
              </div>
              <hr class="dark horizontal my-0">
              <div class="card-footer p-3">
                <p class="mb-0"><span class="text-success text-sm font-weight-bolder">+<%= usersOntheMonth?
                      usersOntheMonth: 0 %> </span>on this month</p>
              </div>
            </div>
          </div>



          <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
            <div class="card">
              <div class="card-header p-3 pt-2">
                <div
                  class="icon icon-lg icon-shape bg-gradient-success shadow-success text-center border-radius-xl mt-n4 position-absolute">
                  <i class="material-icons opacity-10">person</i>
                </div>
                <div class="text-end pt-1">
                  <p class="text-sm mb-0 text-capitalize">Number of Sales</p>
                  <h4 class="mb-0">
                    <%= totalSalesCount %>
                  </h4>
                </div>
              </div>
              <hr class="dark horizontal my-0">
              <div class="card-footer p-3">
                <p class="mb-0"><span class="text-danger text-sm font-weight-bolder">+<%= salesOnTheYear %></span> Sales
                  on this year</p>
              </div>
            </div>
          </div>


          <div class="col-xl-3 col-sm-6">
            <div class="card">
              <div class="card-header p-3 pt-2">
                <div
                  class="icon icon-lg icon-shape bg-gradient-info shadow-info text-center border-radius-xl mt-n4 position-absolute">
                  <i class="material-icons opacity-10">weekend</i>
                </div>
                <div class="text-end pt-1">
                  <p class="text-sm mb-0 text-capitalize">Sales on This Month</p>
                  <h4 class="mb-0">
                    <%= salesOnTheMonth %>
                  </h4>
                </div>
              </div>
              <hr class="dark horizontal my-0">
              <div class="card-footer p-3">
                <p class="mb-0"><span class="text-success text-sm font-weight-bolder">
                    <%= salesOnPrevMonth %>
                  </span>On Last Month</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Graphs Start  -->
        <div class="d-flex">
          <div class="row mt-4">
            <div class="d-flex">
            <div class="monthlySales  col-12 col-lg-6">
              <div class="p-3 card h-100">
                <!-- <span class="h4 text-center"> Total Sales of <%=// salesYear %> - ₹ <%=//  totalSales %> </span> -->
                <span class="h4 text-center"> Total Sales</span>

                <div class="filterByYear mb-4">
                  <form action="" method="get">
                      <div class="row">
                          <div class="col-md-6 mb-3">
                              <label for="year" class="form-label">Year:</label>
                              <select name="year" id="year" class="form-control">
                                  <% displayYears.forEach(year => { %>
                                  <option value="<%= year %>" <% if (salesYear == year) { %> selected <% } %>><%= year %>
                                  </option>
                                  <% }); %>
                              </select>
                          </div>
                          <div class="col-md-6 mb-3">
                              <label for="month" class="form-label">Month:</label>
                              <select name="month" id="month" class="form-control">
                                  <option value=""> Click </option>
                                  <option value="01">January</option>
                                  <option value="02">February</option>
                                  <option value="03">March</option>
                                  <option value="04">April</option>
                                  <option value="05">May</option>
                                  <option value="06">June</option>
                                  <option value="07">July</option>
                                  <option value="08">August</option>
                                  <option value="09">September</option>
                                  <option value="10">October</option>
                                  <option value="11">November</option>
                                  <option value="12">December</option>
                              </select>
                          </div>
                      </div>
      
                      <!-- Submit and Reset Buttons -->
                      <div class="row justify-content-center">
                          <div class="col-md-6 text-center">
                              <button class="btn btn-success text-nowrap mt-3" type="submit">Submit</button>
                              <a href="/admin" class="btn btn-danger mt-3 mx-2">Reset</a>
                          </div>
                      </div>
                  </form>
              </div>
                <span id="salesData" hidden>
                  <%= sales %>

                </span>
                <span id="monthData" hidden>
                  <%= months %>

                </span>
                <span id="salesYear" hidden>
                  <%= salesYear %>

                </span>

                <!-- chart div -->
                <div id="chart">
                </div>
              </div>
            </div>

            <!-- Category Sales Chart Start -->
            <!-- <div class=" col-lg-6 col-12 mt-5 mt-lg-0 ">
            <div class="p-3 card h-100">
                <h4 class="text-center">Category Sales1</h4>
                <div class="categoryCard">

                    <div id="catChart">
                        <span id="categorySales" hidden>
                          <%= categorySales %>
                        </span>
                        <span id="allCategories" hidden>
                          <%= categories %>
                        </span>
                    </div>

                </div>
            </div>
        </div> -->
            <!-- Category Sales Chart End -->
            <div class="row col-12 col-lg-6 ms-2 ">

              <div class="">
                <div class="p-3 card h-100 ">
                  <h4 class="text-center">Payment Method usage</h4>
                  <div class="paymentCard mt-5">
                    <div id="paymentChart">
                      <span id="paymentMethods" hidden>
                        <%= paymentMethods %>

                      </span>
                      <span id="paymentCount" hidden>
                        <%= paymentCount %>

                      </span>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>




            <div class="col-12 mt-3">
              <div class="p-3 card salesReportCard  h-100">
                <h4 class="text-center">Sales Report</h4>
                <div class="mt-3">
                  <form action="" method="get">
                    <label for="fromDate" class="form-label"> From: </label>
                    <input type="date" name="fromDate" id="fromDate" class="form-control mb-3" required>
                    <small id="fromDateErr" class="error"></small><br>

                    <label for="toDate" class="form-label"> To: </label>
                    <input type="date" name="toDate" id="toDate" class="form-control mb-3" required>
                    <small id="toDateErr" class="error"></small><br>

                    <div class="text-center mt-3">
                      <button class="btn btn-success w-10" type="submit" onclick="return validateSalesDate()">Get
                        </button>
                    </div>
                  </form>
                  <div class="text-center mt-2">
                    <a href="/admin"><button class="btn btn-secondary  w-10">Reset</button></a>
                    <!-- use script to remove date value -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <%if(orderDataToDownload && orderDataToDownload.length>0) {%>

          <div class="salesReportData mb-5 px-3">
            <div  class="mt-5" style="text-align: center;">
              <h3>Sales Report Table</h3>
            </div>
            <div class="mt-1 mb-1 d-flex justify-content-between">
              <button class="btn btn-primary" onclick="printTable()">Export Pdf <i
                  class="bi bi-filetype-pdf"></i></button> <button onclick="exportReportToExcel()"
                class="btn btn-success">Export
                Excel <i class="bi bi-file-earmark-spreadsheet"></i></button>
            </div>
            <div class="table-responsive">
              <table class="table table-striped table-bordered " id="sortTable" cellspacing="0" width="100%">
                <thead class="thead-light">
                  <tr>
                    <th scope="col"># No</th>
                    <th scope="col">Date</th>
                    <th scope="col">User</th>
                    <th scope="col">OrderId</th>
                    <!-- <th scope="col">Products</th> -->
                    <!-- <th scope="col">Price</th> -->
                    <th scope="col">Total Price</th>
                    <th scope="col">Payment</th>
                  </tr>
                </thead>
                <tbody>
                  <% orderDataToDownload.forEach((order, index)=>{ %>
                    <tr>
                      <th scope="row">
                        <%= index +1 %>
                      </th>
                      <% const dd=order.createdAt.getDate(); const mm=order.createdAt.getMonth() + 1; const
                        yyyy=order.createdAt.getFullYear(); const formattedDate=`${dd}-${mm}-${yyyy}`; %>
                        <td>
                          <%=formattedDate %>
                        </td>
                        <td>
                          <%= order.userName %>
                        </td>
                        <td>
                          <%=order._id%>

                        </td>
                        <td>
                          &#8377;<%=order.totalAmount %>

                        </td>
                        <td>
                          <%=order.paymentMethod %>

                        </td>
                    </tr>
                    <% }) %>


                </tbody>
              </table>
              <div id="salesReportDownloadableTable" hidden>
                <table class="table text-center w-100" id="downloadTable">
                  <div class="text-center">
                    <h1>Sales Report -SPECART</h1>

                  </div>
                  <thead>
                    <tr>
                      <th scope="col">#</th>
                      <th scope="col">Date</th>
                      <th scope="col">Name</th>
                      <th scope="col">OrderId</th>
                      <th scope="col">Quantity</th>
                      <th scope="col">Payment</th>
                      <th scope="col">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% orderDataToDownload.forEach((order, index)=>{ %>

                      <tr>
                        <th scope="row">
                          <%= index+1 %>

                        </th>
                        <% const dd=order.createdAt.getDate(); const mm=order.createdAt.getMonth() +1; const
                          yyyy=order.createdAt.getFullYear(); const formattedDate=`${dd}-${mm}-${yyyy}`; %>
                          <td>
                            <%=formattedDate %>

                          </td>
                          <td>
                            <%= order.userName %>
                          </td>
                          <td>
                            <%=order._id%>

                          </td>

                          <td>
                            <%=order.products.length %>

                          </td>
                          <td>
                            <%=order.paymentMethod %>
                          </td>
                          <td>
                            <%=order.totalAmount %>
                          </td>
                      </tr>
                      <% }) %>

                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <% } %>

            <%- include('../layouts/admin/footer.ejs') %>


      </div>
    </main>


    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"> </script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.8/xlsx.full.min.js"></script>



    <!-- Sales Chart  -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var salesPerMonthElements = document.getElementById('salesData').innerHTML;
        var salesData = salesPerMonthElements.split(',').map(Number);

        var salesMonths = document.getElementById('monthData').innerHTML;
        console.log("salesMonths:", salesMonths);

        var monthData = salesMonths.split(',');

        let yearOfSale = document.getElementById('salesYear').textContent;

        console.log("salesData:", salesData);
        console.log("monthData:", monthData);
        console.log("yearOfSale:", yearOfSale);

        var options = {
          series: [{
            name: "Sales",
            data: salesData
          }],
          chart: {
            height: 350,
            type: 'line',
            zoom: {
              enabled: false
            }
          },
          dataLabels: {
            enabled: false
          },
          stroke: {
            curve: 'straight'
          },
          title: {
            text: `Sales of the each month in year ${yearOfSale}`,
            align: 'left'
          },
          grid: {
            row: {
              colors: ['#f3f3f3', 'transparent'],
              opacity: 0.5
            },
          },
          xaxis: {
            categories: monthData,
            // title: {
            //   text: 'months'
            // }
          },
          yaxis: {
            title: {
              text: 'sales'
            }
          }
        };

        var chart = new ApexCharts(document.querySelector("#chart"), options);
        chart.render();
      });

    </script>


    <!-- Category Chart  -->
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        var categoryNamesData = document.getElementById('allCategories').innerHTML;
        var categoryNames = categoryNamesData.split(',');

        var categorySalesData = document.getElementById('categorySales').innerHTML;
        var categorySales = categorySalesData.split(',');

        // console.log('categoryNames: ', categoryNames);
        // console.log('categorySales: ', categorySales);


        function generateRandomColor() {
          const letters = '0123456789ABCDEF';
          let color = '#';
          for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
          }
          return color;
        }

        function pushRandomUniqueColorsToArray(array, numColors) {
          for (let i = 0; i < numColors; i++) {
            let newColor;
            do {
              newColor = generateRandomColor();
            } while (array.includes(newColor));

            array.push(newColor);
          }
        }

        // Example usage
        const colorsArray = [];
        pushRandomUniqueColorsToArray(colorsArray, categorySales.length);
        var options = {
          series: [{
            name: 'Net Sales',
            data: categorySales
          }],
          chart: {
            type: 'bar',
            height: 350
          },
          plotOptions: {
            bar: {
              borderRadius: 0,
              distributed: true,
              barHeight: '80%',
            },
          },
          colors: colorsArray,
          dataLabels: {
            enabled: false,

          },
          stroke: {
            show: true,
            width: 2,
            colors: ['transparent']
          },
          xaxis: {
            categories: categoryNames,
            title: {
              text: 'Categories'
            }
          },
          yaxis: {
            title: {
              text: 'Sales'
            }
          },
          fill: {
            opacity: 1
          },
          tooltip: {
            y: {
              formatter: function (val) {
                return "₹ " + val
              }
            }
          }
        };

        var chartContainer = document.querySelector("#catChart");
        // console.log('Chart Container:', chartContainer);

        var chart = new ApexCharts(chartContainer, options);
        chart.render();

      });
    </script>



    <!-- payment -->
    <script>
      var paymentMethodsData = document.getElementById('paymentMethods').innerHTML;
      var paymentMethods = paymentMethodsData.split(',')

      var paymentCountData = document.getElementById('paymentCount').innerHTML;
      var paymentCount = paymentCountData.split(',').map(item => Number(item.trim()));
      paymentCount.map((data) => parseInt(data))
      console.log(paymentCount);

      var options = {
        series: paymentCount,
        chart: {
          width: 380,
          type: 'pie',
        },
        labels: paymentMethods,
        responsive: [{
          breakpoint: 480,
          options: {
            chart: {
              width: 200
            },
            legend: {
              position: 'bottom'
            }
          }
        }]
      };

      var chart = new ApexCharts(document.querySelector("#paymentChart"), options);
      chart.render();
    </script>

    <script>
      function exportReportToExcel() {
        // Include the SheetJS library


        // Get the table element
        const table = document.getElementById("downloadTable");
        document.getElementById("downloadTable").hidden = false

        // Convert the table to a workbook
        const workbook = XLSX.utils.table_to_book(table);

        // Convert the workbook to a binary Excel file
        const excelBinary = XLSX.write(workbook, { bookType: "xlsx", type: "binary" });

        // Create a Blob object and download the file
        const blob = new Blob([s2ab(excelBinary)], { type: "application/octet-stream" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "salesReport.xlsx";
        link.click();

        // Utility function to convert a string to an ArrayBuffer
        function s2ab(s) {
          const buf = new ArrayBuffer(s.length);
          const view = new Uint8Array(buf);
          for (let i = 0; i < s.length; i++) {
            view[i] = s.charCodeAt(i) & 0xff;
          }
          return buf;
        }
        document.getElementById("downloadTable").hidden = true


      }

    </script>
    <script>
      function printTable() {
        var table = document.getElementById("salesReportDownloadableTable");
        table.hidden = false;

        var newWin = window.open('', 'Print-Window');
        newWin.document.open();

        // Add necessary CSS styles for the table
        newWin.document.write('<html><head><style>');
        newWin.document.write('table { border-collapse: collapse; width: 100%; }');
        newWin.document.write('table, th, td { border: 1px solid black; }');
        newWin.document.write('</style></head><body onload="window.print()">');

        // Write the table HTML
        newWin.document.write(table.outerHTML);

        newWin.document.write('</body></html>');
        newWin.document.close();

        setTimeout(function () { newWin.close(); }, 10);
        table.hidden = true;
      }

    </script>



    <%- include('../layouts/admin/footer.ejs') %>